<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Hub - College Edition</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Added Fonts for new Login Page -->
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;600&display=swap" rel="stylesheet">
    
    <style>
        /* Base styling - Changed to Poppins for new login form */
        body {
            font-family: 'Poppins', sans-serif;
        }
        
        /* Custom styles for animations and glassmorphism */
        .glass-nav {
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            background-color: rgba(255, 255, 255, 0.6);
        }
        
        .dark .glass-nav {
            background-color: rgba(17, 24, 39, 0.6); /* dark:bg-gray-900/60 */
        }
        
        .glass-card {
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            background-color: rgba(255, 255, 255, 0.5);
        }
        
        .dark .glass-card {
            background-color: rgba(31, 41, 55, 0.5); /* dark:bg-gray-800/50 */
        }

        .glass-modal {
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            background-color: rgba(255, 255, 255, 0.8);
        }
        
        .dark .glass-modal {
            background-color: rgba(17, 24, 39, 0.8); /* dark:bg-gray-900/80 */
        }
        
        /* --- Styles for new Glassmorphism Login --- */

        .auth-background{
            width: 430px;
            height: 520px;
            position: absolute;
            transform: translate(-50%,-50%);
            left: 50%;
            top: 50%;
            z-index: -1; /* Place it behind the form */
        }
        .auth-background .shape{
            height: 200px;
            width: 200px;
            position: absolute;
            border-radius: 50%;
        }
        .shape:first-child{
            background: linear-gradient(
                #1845ad,
                #23a2f6
            );
            left: -80px;
            top: -80px;
        }
        .shape:last-child{
            background: linear-gradient(
                to right,
                #ff512f,
                #f09819
            );
            right: -30px;
            bottom: -80px;
        }
        .auth-glass-form{
            min-height: 520px; /* Changed from height */
            height: auto; /* Added for signup form */
            width: 400px;
            background-color: rgba(255,255,255,0.13);
            position: relative; /* Changed from absolute */
            border-radius: 10px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255,255,255,0.1);
            box-shadow: 0 0 40px rgba(8,7,16,0.6);
            padding: 50px 35px;
            /* Ensure it's rendered on top of the modal's backdrop */
            margin: auto; 
        }
        .auth-glass-form *{
            font-family: 'Poppins',sans-serif;
            color: #ffffff;
            letter-spacing: 0.5px;
            outline: none;
            border: none;
        }
        .auth-glass-form h3{
            font-size: 32px;
            font-weight: 500;
            line-height: 42px;
            text-align: center;
        }

        .auth-glass-form label{
            display: block;
            margin-top: 30px;
            font-size: 16px;
            font-weight: 500;
        }
        .auth-glass-form input{
            display: block;
            height: 50px;
            width: 100%;
            background-color: rgba(255,255,255,0.07);
            border-radius: 3px;
            padding: 0 10px;
            margin-top: 8px;
            font-size: 14px;
            font-weight: 300;
        }
        .auth-glass-form ::placeholder{
            color: #e5e5e5;
        }
        .auth-glass-form button{
            margin-top: 50px;
            width: 100%;
            background-color: #ffffff;
            color: #080710;
            padding: 15px 0;
            font-size: 18px;
            font-weight: 600;
            border-radius: 5px;
            cursor: pointer;
        }
        .auth-glass-form .social{
          margin-top: 30px;
          display: flex;
        }
        .auth-glass-form .social div{
          background: red;
          width: 150px;
          border-radius: 3px;
          padding: 5px 10px 10px 5px;
          background-color: rgba(255,255,255,0.27);
          color: #eaf0fb;
          text-align: center;
        }
        .auth-glass-form .social div:hover{
          background-color: rgba(255,255,255,0.47);
        }
        .auth-glass-form .social .fb{
          margin-left: 25px;
        }
        .auth-glass-form .social i{
          margin-right: 4px;
        }

        /* --- Added styles for tabs and signup form --- */
        .auth-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }
        .auth-tab-btn {
            font-family: 'Poppins', sans-serif;
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            font-size: 18px;
            font-weight: 500;
            padding: 10px 20px;
            cursor: pointer;
            transition: color 0.3s ease;
        }
        .auth-tab-btn:hover {
            color: #ffffff;
        }
        .auth-tab-btn.active {
            color: #ffffff;
            border-bottom: 2px solid #ffffff;
            margin-bottom: -2px; /* Align with container border */
        }
        /* Hide signup form by default */
        #signup-form {
            display: none;
        }
        /* Make signup form inputs have less top margin to fit */
        #signup-form label {
            margin-top: 15px;
        }
        #signup-form input, #signup-form select {
            margin-top: 5px;
            height: 45px; /* Slightly shorter to fit more */
        }
        /* Style for the select dropdown */
        .auth-glass-form select {
            display: block;
            width: 100%;
            background-color: rgba(255,255,255,0.07);
            border-radius: 3px;
            padding: 0 10px;
            margin-top: 8px;
            font-size: 14px;
            font-weight: 300;
            height: 50px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg fill="white" height="24" viewBox="0 0 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>');
            background-repeat: no-repeat;
            background-position-x: 98%;
            background-position-y: 50%;
        }
        .auth-glass-form select option {
            background-color: #080710; /* Dark background for options */
            color: #ffffff;
        }
        /* Container for grid layouts */
        .auth-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        /* --- End of new Login Styles --- */

        .filter-bar {
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            background-color: rgba(255, 255, 255, 0.3);
        }

        .dark .filter-bar {
            background-color: rgba(17, 24, 39, 0.3); /* dark:bg-gray-900/30 */
        }

        /* Custom animation for hero text */
        .hero-word {
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        }
        .hero-word-enter {
            opacity: 0;
            transform: translateY(30px);
        }
        .hero-word-exit {
            opacity: 0;
            transform: translateY(-30px);
        }

        /* Staggered card fade-in animation */
        @keyframes card-fade-in {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .event-card-animated {
            animation: card-fade-in 0.4s ease-out forwards;
            animation-delay: var(--delay);
            opacity: 0; /* Start hidden */
        }

        /* Vote button pop animation */
        .vote-btn:active {
            transform: scale(0.9);
            transition: transform 0.1s ease;
        }
        .vote-btn-voted-animation {
            animation: vote-pop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        @keyframes vote-pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        /* Custom float label for auth forms (No longer used by new login) */
        .form-input-container {
            position: relative;
        }
        .form-input {
            padding-top: 1.5rem; /* Make space for label */
        }
        .form-label {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1rem;
            color: #6b7280; /* gray-500 */
            transition: all 0.2s ease-in-out;
            pointer-events: none;
            background: transparent;
            padding: 0 0.25rem;
        }
        .dark .form-label {
            color: #9ca3af; /* dark:gray-400 */
        }
        /* State when input has value or is focused */
        .form-input:focus + .form-label,
        .form-input:not(:placeholder-shown) + .form-label {
            top: 0.125rem; /* ADJUSTED AGAIN: Lifted label even higher */
            transform: translateY(0);
            font-size: 0.75rem; /* text-xs */
            color: #a855f7; /* purple-500 */
            background-color: var(--label-bg-color, #ffffff); 
            /* Added padding adjustment for icon spacing */
            padding-left: 0.125rem; 
            padding-right: 0.125rem;
        }
        .dark .form-input:focus + .form-label,
        .dark .form-input:not(:placeholder-shown) + .form-label {
            color: #c084fc; /* dark:purple-400 */
            background-color: var(--label-bg-color-dark, #1f2937);
        }

        /* Ensure select label doesn't overlap */
        select.form-input + .form-label {
             /* Match the lifted position */
             top: 0.125rem; 
             /* Override general left padding for select which doesn't have icon */
             left: 1rem; 
             transform: translateY(0);
             font-size: 0.75rem;
             background-color: var(--label-bg-color, #ffffff);
             color: #6b7280; /* gray-500 */
             padding: 0 0.25rem; 
             pointer-events: none; /* Make sure it's not clickable */
        }
        /* Ensure select label gets correct color on focus */
       select.form-input:focus + .form-label {
             color: #a855f7; /* purple-500 */
        }
       .dark select.form-input:focus + .form-label {
            color: #c084fc; /* dark:purple-400 */
       }


        /* Prose styles for event description (simplified) */
        .prose p {
            margin-top: 1.25em;
            margin-bottom: 1.25em;
        }
        .prose h2 {
            font-size: 1.5rem;
            line-height: 2rem;
            font-weight: 600;
            margin-top: 1.5em;
            margin-bottom: 0.8em;
        }
        .dark .dark\:prose-invert {
            color: #d1d5db; /* dark:text-gray-300 */
        }
        .dark .dark\:prose-invert h2 {
            color: #ffffff; /* dark:text-white */
        }

        /* Hide elements */
        .hidden {
            display: none;
        }
    </style>
    
    <script>
        // Tailwind dark mode configuration
        tailwind.config = {
            darkMode: 'class', // 'media' or 'class'
            theme: {
                extend: {
                    fontFamily: {
                        // Changed sans default to Poppins
                        sans: ['Poppins', 'sans-serif'], 
                    },
                },
            },
        }
    </script>
</head>
<body class="min-h-screen bg-gradient-to-br from-purple-50 via-pink-50 to-blue-50
             dark:from-gray-900 dark:via-purple-900/40 dark:to-gray-900
             transition-colors duration-500 text-gray-900 dark:text-gray-100">

    <!-- App Container -->
    <div id="app-root">

        <!-- 1. Main Header (Desktop) -->
        <header id="main-header" class="fixed top-0 left-0 right-0 z-40 transition-transform duration-300">
            <nav class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
                <div class="mt-4 flex items-center justify-between h-16 p-4 rounded-2xl
                            glass-nav border border-white/20 dark:border-gray-800/50 shadow-lg">
                    
                    <!-- Logo/Title -->
                    <div class="flex items-center space-x-2 cursor-pointer transition-transform hover:scale-105" onclick="handleSetPage('home')">
                        <div class="w-8 h-8 rounded-full bg-gradient-to-br from-purple-400 to-pink-500 flex items-center justify-center">
                            <i data-lucide="calendar-check" class="w-5 h-5 text-white"></i>
                        </div>
                        <span class="font-bold text-xl text-gray-900 dark:text-white">EventHub</span>
                    </div>

                    <!-- Desktop Navigation -->
                    <div id="desktop-nav-links" class="hidden md:flex items-center space-x-2">
                        <button onclick="handleSetPage('home')" data-page="home" class="nav-button relative px-4 py-2 rounded-lg text-sm font-medium flex items-center space-x-2 transition-all text-gray-900 dark:text-white transform hover:scale-105">
                            <i data-lucide="home" class="w-4 h-4"></i>
                            <span>Home</span>
                            <div class="nav-underline absolute -bottom-1 left-0 right-0 h-0.5 bg-purple-500"></div>
                        </button>
                        <button onclick="handleSetPage('myCalendar')" data-page="myCalendar" class="nav-button relative px-4 py-2 rounded-lg text-sm font-medium flex items-center space-x-2 transition-all text-gray-500 hover:text-gray-900 dark:hover:text-white transform hover:scale-105">
                            <i data-lucide="calendar" class="w-4 h-4"></i>
                            <span>My Calendar</span>
                            <div class="nav-underline absolute -bottom-1 left-0 right-0 h-0.5 bg-purple-500 hidden"></div>
                        </button>
                        <button onclick="handleSetPage('voteTopics')" data-page="voteTopics" class="nav-button relative px-4 py-2 rounded-lg text-sm font-medium flex items-center space-x-2 transition-all text-gray-500 hover:text-gray-900 dark:hover:text-white transform hover:scale-105">
                            <i data-lucide="bar-chart-3" class="w-4 h-4"></i>
                            <span>Vote Topics</span>
                            <div class="nav-underline absolute -bottom-1 left-0 right-0 h-0.5 bg-purple-500 hidden"></div>
                        </button>
                    </div>

                    <!-- Actions -->
                    <div id="header-actions" class="flex items-center space-x-2">
                        <!-- This content is rendered by renderHeaderActions() -->
                    </div>
                </div>
            </nav>
            
            <!-- Notification Panel (Hidden by default) -->
            <div id="notification-panel" class="absolute top-24 right-4 sm:right-6 lg:right-8 z-50 w-full max-w-sm
                                                rounded-2xl glass-modal border border-white/20 dark:border-gray-700/50
                                                shadow-2xl overflow-hidden transition-all duration-300
                                                transform scale-95 opacity-0 -translate-y-2 hidden">
                <div class="p-4 flex justify-between items-center border-b border-gray-200 dark:border-gray-700">
                    <h3 class="font-bold text-lg text-gray-900 dark:text-white">Notifications</h3>
                    <button onclick="toggleNotificationPanel(false)" class="p-2 -m-2 text-gray-500 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                <div id="notification-list" class="max-h-96 overflow-y-auto p-2 space-y-2">
                    <!-- Notifications injected here -->
                </div>
            </div>

            <!-- Profile Dropdown (Hidden by default) -->
            <div id="profile-dropdown" class="absolute top-24 right-4 sm:right-6 lg:right-8 z-50 w-48
                                              rounded-2xl glass-modal border border-white/20 dark:border-gray-700/50
                                              shadow-2xl overflow-hidden transition-all duration-300
                                              transform scale-95 opacity-0 -translate-y-2 hidden">
                <div class="p-2 space-y-1">
                    <button class="w-full flex items-center space-x-2 px-3 py-2 rounded-lg text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
                        <i data-lucide="settings" class="w-4 h-4"></i>
                        <span>Settings</span>
                    </button>
                    <button onclick="handleLogout()" class="w-full flex items-center space-x-2 px-3 py-2 rounded-lg text-sm text-red-500 hover:bg-red-100 dark:hover:bg-red-900/50 transition-colors">
                        <i data-lucide="log-out" class="w-4 h-4"></i>
                        <span>Log Out</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- 2. Main Content Area -->
        <main id="main-content" class="transition-opacity duration-300 pt-24 pb-24 md:pb-8">
            <!-- Content will be injected by JavaScript -->
        </main>

        <!-- 3. Mobile Bottom Navigation -->
        <nav id="mobile-bottom-nav" class="md:hidden fixed bottom-0 left-0 right-0 z-40 transition-transform duration-300">
            <div class="mx-auto max-w-md px-4 pb-4">
                <div class="flex justify-around items-center h-16 rounded-2xl glass-nav
                            border border-white/20 dark:border-gray-800/50 shadow-lg">
                    
                    <button onclick="handleSetPage('home')" data-page="home" class="mobile-nav-button relative flex flex-col items-center justify-center w-20 h-full rounded-lg text-sm font-medium transition-all duration-300 text-purple-500">
                        <i data-lucide="home" class="w-6 h-6"></i>
                        <span class="text-xs mt-1">Home</span>
                        <div class="mobile-nav-active absolute top-1 w-8 h-1 bg-purple-500 rounded-full"></div>
                    </button>
                    <button onclick="handleSetPage('myCalendar')" data-page="myCalendar" class="mobile-nav-button relative flex flex-col items-center justify-center w-20 h-full rounded-lg text-sm font-medium transition-all duration-300 text-gray-500 hover:text-gray-900 dark:hover:text-white">
                        <i data-lucide="calendar" class="w-6 h-6"></i>
                        <span class="text-xs mt-1">My Calendar</span>
                        <div class="mobile-nav-active absolute top-1 w-8 h-1 bg-purple-500 rounded-full hidden"></div>
                    </button>
                    <button onclick="handleSetPage('voteTopics')" data-page="voteTopics" class="mobile-nav-button relative flex flex-col items-center justify-center w-20 h-full rounded-lg text-sm font-medium transition-all duration-300 text-gray-500 hover:text-gray-900 dark:hover:text-white">
                        <i data-lucide="bar-chart-3" class="w-6 h-6"></i>
                        <span class="text-xs mt-1">Vote Topics</span>
                        <div class="mobile-nav-active absolute top-1 w-8 h-1 bg-purple-500 rounded-full hidden"></div>
                    </button>
                </div>
            </div>
        </nav>

        <!-- 4. Toast Notification Container -->
        <div id="toast-container" class="fixed bottom-4 md:bottom-auto md:top-24 right-4 z-[100] w-full max-w-sm space-y-3">
            <!-- Toasts will be injected by JavaScript -->
        </div>

        <!-- 5. Registration Modal (Hidden by default) -->
        <div id="registration-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm hidden">
            <div id="registration-modal-content" class="relative w-full max-w-lg p-6 md:p-8 rounded-3xl
                       glass-modal border border-white/20 dark:border-gray-700/50
                       shadow-2xl overflow-hidden transition-all duration-300 transform scale-95 opacity-0">
                
                <!-- Form View -->
                <div id="modal-form-view">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h2 class="text-2xl md:text-3xl font-bold text-gray-900 dark:text-white">Register</h2>
                            <p id="modal-event-title" class="text-sm text-gray-600 dark:text-gray-400">For "Event Title"</p>
                        </div>
                        <button id="modal-close-btn" class="p-2 text-gray-500 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-all hover:scale-110 hover:rotate-90">
                            <i data-lucide="x"></i>
                        </button>
                    </div>

                    <form id="registration-form" class="space-y-4">
                        <input type="hidden" id="modal-event-id" />
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- FormInput Component (This now uses the original styles, not the new login ones) -->
                            <div class="relative">
                                <input id="name" name="name" type="text" required class="form-input peer w-full px-4 py-3 bg-white/50 dark:bg-gray-800/50 border border-gray-300 dark:border-gray-700 rounded-lg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-purple-400 placeholder-transparent" placeholder="Name" />
                                <label for="name" class="form-label absolute left-4 -top-2.5 px-1 text-xs text-gray-600 dark:text-gray-400 bg-white dark:bg-gray-900 transition-all peer-placeholder-shown:text-base peer-placeholder-shown:text-gray-400 peer-placeholder-shown:top-3.5 peer-focus:-top-2.5 peer-focus:text-xs peer-focus:text-purple-500">Name</label>
                            </div>
                            <!-- FormInput Component -->
                            <div class="relative">
                                <input id="email" name="email" type="email" required class="form-input peer w-full px-4 py-3 bg-white/50 dark:bg-gray-800/50 border border-gray-300 dark:border-gray-700 rounded-lg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-purple-400 placeholder-transparent" placeholder="Email" />
                                <label for="email" class="form-label absolute left-4 -top-2.5 px-1 text-xs text-gray-600 dark:text-gray-400 bg-white dark:bg-gray-900 transition-all peer-placeholder-shown:text-base peer-placeholder-shown:text-gray-400 peer-placeholder-shown:top-3.5 peer-focus:-top-2.5 peer-focus:text-xs peer-focus:text-purple-500">Email</label>
                            </div>
                        </div>
                        <!-- FormInput Component -->
                        <div class="relative">
                            <input id="studentId" name="studentId" type="text" required class="form-input peer w-full px-4 py-3 bg-white/50 dark:bg-gray-800/50 border border-gray-300 dark:border-gray-700 rounded-lg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-purple-400 placeholder-transparent" placeholder="Student ID" />
                            <label for="studentId" class="form-label absolute left-4 -top-2.5 px-1 text-xs text-gray-600 dark:text-gray-400 bg-white dark:bg-gray-900 transition-all peer-placeholder-shown:text-base peer-placeholder-shown:text-gray-400 peer-placeholder-shown:top-3.5 peer-focus:-top-2.5 peer-focus:text-xs peer-focus:text-purple-500">Student ID</label>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- FormInput Component -->
                            <div class="relative">
                                <input id="department" name="department" type="text" class="form-input peer w-full px-4 py-3 bg-white/50 dark:bg-gray-800/50 border border-gray-300 dark:border-gray-700 rounded-lg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-purple-400 placeholder-transparent" placeholder="Department" />
                                <label for="department" class="form-label absolute left-4 -top-2.5 px-1 text-xs text-gray-600 dark:text-gray-400 bg-white dark:bg-gray-900 transition-all peer-placeholder-shown:text-base peer-placeholder-shown:text-gray-400 peer-placeholder-shown:top-3.5 peer-focus:-top-2.5 peer-focus:text-xs peer-focus:text-purple-500">Department</label>
                            </div>
                            <!-- FormSelect Component -->
                            <div class="relative">
                                <select id="year" name="year" class="form-input w-full px-4 py-3 bg-white/50 dark:bg-gray-800/50 border border-gray-300 dark:border-gray-700 rounded-lg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-purple-400 appearance-none">
                                    <option value="1">1st Year</option>
                                    <option value="2">2nd Year</option>
                                    <option value="3">3rd Year</option>
                                    <option value="4">4th Year</option>
                                    <option value="5">Graduate</option>
                                </select>
                                <label for="year" class="form-label absolute left-4 -top-2.5 px-1 text-xs text-gray-600 dark:text-gray-400 bg-white dark:bg-gray-900">Year</label>
                                <i data-lucide="chevron-down" class="absolute right-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400 pointer-events-none"></i>
                            </div>
                        </div>

                        <div class="pt-4">
                            <button type="submit" id="modal-submit-btn" class="w-full flex justify-center items-center px-6 py-3 rounded-xl font-semibold text-white bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 focus:outline-none focus:ring-4 focus:ring-purple-300 dark:focus:ring-purple-800 transition-all duration-300 ease-in-out shadow-lg hover:shadow-xl disabled:opacity-50 disabled:cursor-wait">
                                <span>Confirm Registration</span>
                                <i data-lucide="loader-2" class="w-5 h-5 animate-spin hidden"></i>
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- Success View -->
                <div id="modal-success-view" class="hidden flex-col items-center justify-center space-y-4 h-96">
                    <div class="transition-all transform scale-0">
                        <i data-lucide="check-circle" class="w-24 h-24 text-green-500"></i>
                    </div>
                    <h2 class="text-3xl font-bold text-gray-800 dark:text-white">You're In!</h2>
                    <p id="modal-success-message" class="text-gray-600 dark:text-gray-300">See you at ...</p>
                </div>
            </div>
        </div>

        <!-- 6. Auth Modal (Hidden by default) -->
        <!-- This modal now gets its content from the new createAuthModalHTML function -->
        <div id="auth-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm hidden">
            <div id="auth-modal-content" class="relative w-full max-w-md transition-all duration-300 transform scale-95 opacity-0">
                <!-- Auth content injected by JS -->
            </div>
        </div>

    </div>

    <!-- Main Application Script -->
    <script>
        // --- 1. State ---
        let state = {
            page: 'home', // 'home', 'eventDetail', 'myCalendar', 'voteTopics'
            selectedEventId: null,
            darkMode: false,
            user: null, // Start as logged out
            events: [],
            topics: [],
            notifications: [],
            isLoading: true,
            filters: {
                searchTerm: '',
                sortBy: 'date',
                viewMode: 'grid',
                selectedCategory: 'All',
            },
            toastId: 0,
            isNotificationPanelOpen: false,
            isProfileDropdownOpen: false,
            // Add new properties for anonymous voting
            anonymousVotedEvents: [],
            anonymousVotedTopics: [],
        };

        // --- 2. Mock Data ---
        const sampleEvents = [
            { id: '1', title: 'Quantum Computing Summit', description: 'Explore the next frontier of computation. A full-day summit featuring talks from industry pioneers, hands-on workshops, and a networking session. Discover how quantum computing will revolutionize fields from medicine to finance.', date: new Date(Date.now() + 2 * 24 * 60 * 60 * 1000).toISOString(), location: 'Building 7, Quantum Auditorium', category: 'Technology', tags: ['Quantum', 'AI', 'Future Tech'], organizer: 'Dept. of Computer Science', imageUrl: 'https://placehold.co/600x400/C9B8FF/333333?text=Quantum+Summit', votesCount: 120, attendeeCount: 120 },
            { id: '2', title: 'Momentum: Annual Dance Showcase', description: 'Experience the rhythm and passion of our university\'s best dance troupes. A spectacular night showcasing styles from hip-hop and contemporary to classical and salsa. Get ready to be mesmerized!', date: new Date(Date.now() + 5 * 24 * 60 * 60 * 1000).toISOString(), location: 'Grand Symphony Hall', category: 'Cultural', tags: ['Dance', 'Music', 'Arts'], organizer: 'University Dance Club', imageUrl: 'https://placehold.co/600x400/FFD1DC/333333?text=Momentum+Dance', votesCount: 85, attendeeCount: 85 },
            { id: '3', title: 'Startup Pitch Night 2025', description: 'Watch the brightest minds on campus pitch their million-dollar ideas to a panel of venture capitalists. The winner takes home the coveted Innovation Prize. Includes a keynote from a successful alum founder.', date: new Date(Date.now() + 10 * 24 * 60 * 60 * 1000).toISOString(), location: 'Innovation Hub, G-Floor', category: 'Career', tags: ['Startups', 'Business', 'Networking'], organizer: 'Entrepreneurship Cell', imageUrl: 'https://placehold.co/600x400/B8E6D3/333333?text=Pitch+Night', votesCount: 210, attendeeCount: 210 },
            { id: '4', title: 'Varsity Basketball Finals', description: 'The final showdown! Our university team faces their arch-rivals for the championship title. Come in your university colors and cheer our team to victory. Expect a high-energy game and a halftime show.', date: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000).toISOString(), location: 'University Sports Arena', category: 'Sports', tags: ['Basketball', 'Championship', 'Team Spirit'], organizer: 'Athletics Department', imageUrl: 'https://placehold.co/600x400/FFF0B3/333333?text=Varsity+Finals', votesCount: 150, attendeeCount: 150 },
            { id: '5', title: 'AI Ethics Debate', description: 'A thought-provoking panel discussion on the moral and ethical implications of artificial intelligence. Is AI a threat or a promise? Featuring professors, industry experts, and student representatives.', date: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(), location: 'Philosophy Hall, Room 101', category: 'Academic', tags: ['AI', 'Ethics', 'Debate'], organizer: 'Philosophy Club', imageUrl: 'https://placehold.co/600x400/B3E5FC/333333?text=AI+Ethics', votesCount: 65, attendeeCount: 65 },
            { id: '6', title: 'Spring Fling: Outdoor Concert', description: 'Celebrate the end of exams with our annual outdoor concert on the main lawn. Featuring live bands, food trucks, and chill vibes. A perfect way to unwind with friends.', date: new Date(Date.now() + 14 * 24 * 60 * 60 * 1000).toISOString(), location: 'Main University Lawn', category: 'Social', tags: ['Music', 'Food', 'Festival'], organizer: 'Student Life Committee', imageUrl: 'https://placehold.co/600x400/F8BBD0/333333?text=Spring+Fling', votesCount: 300, attendeeCount: 300 },
        ];

        const sampleTopics = [
            { id: 't1', title: 'University-wide AI Hackathon', description: 'A 48-hour event to build and demo AI-powered projects.', votes: 178, category: 'Technology' },
            { id: 't2', title: 'Guest Lecture: Nobel Laureate', description: 'Invite a Nobel Prize winner for a campus-wide talk.', votes: 230, category: 'Academic' },
            { id: 't3', title: 'Inter-College Sports Carnival', description: 'A week-long sports event with neighboring universities.', votes: 155, category: 'Sports' },
            { id: 't4', title: 'Spring Music Festival Theme: 90s Retro', description: 'Vote for a 90s theme for the upcoming Spring Fling.', votes: 98, category: 'Social' },
        ];

        const sampleNotifications = [
            { id: 'n1', text: 'Your registration for "Quantum Computing Summit" is confirmed!', read: false, eventId: '1', time: new Date(Date.now() - 1 * 60 * 1000).toISOString() },
            { id: 'n2', text: '"Startup Pitch Night 2025" is starting in 1 hour.', read: false, eventId: '3', time: new Date(Date.now() - 5 * 60 * 60 * 1000).toISOString() },
            { id: 'n3', text: 'A new topic "Inter-College Sports Carnival" is now open for voting.', read: true, page: 'voteTopics', time: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString() },
        ];

        // --- 3. DOM References ---
        const mainContent = document.getElementById('main-content');
        const mainHeader = document.getElementById('main-header');
        const mobileBottomNav = document.getElementById('mobile-bottom-nav');
        const desktopNavLinks = document.getElementById('desktop-nav-links');
        const headerActions = document.getElementById('header-actions');
        const toastContainer = document.getElementById('toast-container');
        const modal = document.getElementById('registration-modal');
        const modalContent = document.getElementById('registration-modal-content');
        const modalFormView = document.getElementById('modal-form-view');
        const modalSuccessView = document.getElementById('modal-success-view');
        const notificationPanel = document.getElementById('notification-panel');
        const notificationList = document.getElementById('notification-list');
        const profileDropdown = document.getElementById('profile-dropdown');

        // --- 4. Render Functions ---

        /**
         * Main render function, routes to page-specific renders
         */
        async function renderApp() {
            // Update Nav state
            updateNav();
            // Update Header actions (profile, bell, etc)
            renderHeaderActions();

            // Hide/show main layout elements
            const isDetailPage = state.page === 'eventDetail';
            
            mainHeader.classList.remove('hidden'); // Always show header
            mobileBottomNav.classList.toggle('hidden', isDetailPage);
            desktopNavLinks.classList.toggle('hidden', !state.user); // Hide nav links if logged out
            
            mainHeader.classList.toggle('-translate-y-full', isDetailPage);
            mobileBottomNav.classList.toggle('translate-y-full', isDetailPage);

            if (isDetailPage) {
                mainContent.classList.remove('pt-24', 'pb-24', 'md:pb-8');
            } else {
                mainContent.classList.add('pt-24', 'pb-24', 'md:pb-8');
            }

            // Animate page transition
            mainContent.classList.add('opacity-0');
            
            // Wait for fade-out, then render new content
            await new Promise(resolve => setTimeout(resolve, 150));

            // Render page content
            switch (state.page) {
                case 'home':
                    renderHomePage();
                    break;
                case 'myCalendar':
                    renderMyCalendarPage();
                    break;
                case 'voteTopics':
                    renderTopicVotePage();
                    break;
                case 'eventDetail':
                    renderEventDetailPage();
                    break;
            }
            
            // Animate page fade-in
            mainContent.classList.remove('opacity-0');

            // Re-initialize icons after DOM update
            lucide.createIcons();
        }

        /**
         * Renders the header actions (dark mode, notifications, profile)
         */
        function renderHeaderActions() {
            if (state.user) {
                const unreadCount = state.notifications.filter(n => !n.read).length;
                headerActions.innerHTML = `
                    <button id="dark-mode-toggle" class="p-2 rounded-full text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
                        <i data-lucide="moon" class="w-6 h-6 ${state.darkMode ? 'hidden' : 'block'}"></i>
                        <i data-lucide="sun" class="w-6 h-6 ${state.darkMode ? 'block' : 'hidden'}"></i>
                    </button>
                    <button id="notification-toggle" onclick="toggleNotificationPanel()" class="relative p-2 rounded-full text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
                        <i data-lucide="bell" class="w-6 h-6"></i>
                        ${unreadCount > 0 ? `
                            <span class="absolute top-1 right-1 flex h-3 w-3">
                                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                                <span class="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span>
                            </span>
                        ` : ''}
                    </button>
                    <button id="profile-toggle" onclick="toggleProfileDropdown()" class="w-8 h-8 rounded-full bg-gradient-to-br from-gray-300 to-gray-400 dark:from-gray-700 dark:to-gray-800 flex items-center justify-center text-gray-800 dark:text-white font-bold ring-2 ring-white/50 dark:ring-gray-900/50">
                        ${getInitials(state.user.name)}
                    </button>
                `;
            } else {
                // Logged out state
                headerActions.innerHTML = `
                    <button id="dark-mode-toggle" class="p-2 rounded-full text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
                        <i data-lucide="moon" class="w-6 h-6 ${state.darkMode ? 'hidden' : 'block'}"></i>
                        <i data-lucide="sun" class="w-6 h-6 ${state.darkMode ? 'block' : 'hidden'}"></i>
                    </button>
                    <button onclick="openAuthModal('signin')" class="px-4 py-2 rounded-lg text-sm font-semibold text-white bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 transition-all shadow hover:shadow-md transform hover:scale-105">
                        Sign In
                    </button>
                `;
            }
            // Re-add dark mode listener
            document.getElementById('dark-mode-toggle')?.addEventListener('click', toggleDarkMode);
        }

        /**
         * Renders the NEW Authentication Page as HTML for the modal
         */
        function createAuthModalHTML() {
             return `
                <div class="relative">
                    <!-- The new animated background -->
                    <div class="auth-background">
                        <div class="shape"></div>
                        <div class="shape"></div>
                    </div>
                    
                    <!-- The new form container -->
                    <div class="auth-glass-form"> 
                        
                        <!-- Tab Buttons -->
                        <div class="auth-tabs">
                            <button id="tab-signin" class="auth-tab-btn active" onclick="toggleAuthForm('signin')">Sign In</button>
                            <button id="tab-signup" class="auth-tab-btn" onclick="toggleAuthForm('signup')">Sign Up</button>
                        </div>

                        <!-- Sign In Form -->
                        <form id="signin-form"> 
                            <h3>Login Here</h3>
                    
                            <label for="username">Username</label>
                            <!-- Added name="email" to match handleLogin function -->
                            <input type="text" placeholder="Email or Phone" id="username" name="email" required> 
                    
                            <label for="password">Password</label>
                             <!-- Added name="password" to match handleLogin function -->
                            <input type="password" placeholder="Password" id="password" name="password" required> 
                    
                            <button type="submit">
                                <span>Log In</span>
                                <!-- Added loading spinner, compatible with existing startLoading function -->
                                <i data-lucide="loader-2" class="w-5 h-5 animate-spin hidden" style="color: #080710; margin: auto;"></i>
                            </button>
                            <div class="social">
                                <div class="go"><i class="fab fa-google"></i>  Google</div>
                                <div class="fb"><i class="fab fa-facebook"></i>  Facebook</div>
                            </div>
                        </form>
                        
                        <!-- Sign Up Form (Initially hidden) -->
                        <form id="signup-form">
                            <h3>Create Account</h3>

                            <label for="signup-name">Full Name</label>
                            <input type="text" placeholder="Alex Johnson" id="signup-name" name="signup-name" required> 
                            
                            <label for="signup-email">Email Address</label>
                            <input type="email" placeholder="alex@school.edu" id="signup-email" name="signup-email" required> 

                            <label for="signup-studentid">Student ID</label>
                            <input type="text" placeholder="A12345678" id="signup-studentid" name="signup-studentid" required> 

                            <label for="signup-password">Password</label>
                            <input type="password" placeholder="Min. 6 characters" id="signup-password" name="signup-password" required> 

                            <div class="auth-grid">
                                <div>
                                    <label for="signup-department">Department</label>
                                    <input type="text" placeholder="Computer Science" id="signup-department" name="signup-department"> 
                                </div>
                                <div>
                                    <label for="signup-year">Year</label>
                                    <select id="signup-year" name="signup-year" required>
                                        <option value="" disabled selected>Select Year</option>
                                        <option value="1">1st Year</option>
                                        <option value="2">2nd Year</option>
                                        <option value="3">3rd Year</option>
                                        <option value="4">4th Year</option>
                                        <option value="5">Graduate</option>
                                    </select>
                                </div>
                            </div>
                    
                            <button type="submit">
                                <span>Create Account</span>
                                <i data-lucide="loader-2" class="w-5 h-5 animate-spin hidden" style="color: #080710; margin: auto;"></i>
                            </button>
                        </form>
                    </div>
                    
                    <!-- Close button -->
                    <button onclick="closeAuthModal()" class="absolute top-2 right-2 p-2 text-white/70 rounded-full hover:text-white transition-all hover:scale-110 z-50">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
            `;
        }
        
        /**
         * Renders the Home Page
         */
        function renderHomePage() {
            const categories = ['All', ...new Set(state.events.map(e => e.category))];
            
            mainContent.innerHTML = `
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <!-- Hero Section -->
                    <div class="pt-16 pb-12 text-center">
                        <h1 class="text-5xl md:text-7xl font-bold text-gray-900 dark:text-white">
                            Your College Life,
                        </h1>
                        <div class="relative h-20 md:h-28 mt-2">
                            <h1 id="hero-word" class="hero-word absolute inset-0 text-5xl md:text-7xl font-bold
                               bg-clip-text text-transparent
                               bg-gradient-to-r from-purple-500 via-pink-500 to-orange-400">
                                Discover.
                            </h1>
                        </div>
                        <p class="mt-4 text-lg text-gray-600 dark:text-gray-300 max-w-lg mx-auto">
                            One platform for every event. Never miss out on what's happening on campus.
                        </p>
                    </div>
                    
                    <!-- Filters Section -->
                    <div class="sticky top-20 z-30 mb-8 p-2 filter-bar rounded-2xl border border-white/20 dark:border-gray-800/50">
                        <div class="flex flex-col md:flex-row items-center justify-between gap-4 p-2">
                            <div class="relative w-full md:w-1/2 lg:w-1/3">
                                <input id="search-input" type="text" placeholder="Search events..." value="${state.filters.searchTerm}"
                                       class="w-full pl-10 pr-4 py-3 rounded-lg bg-white/50 dark:bg-gray-800/50
                                              border border-gray-300 dark:border-gray-700
                                              focus:outline-none focus:ring-2 focus:ring-purple-400
                                              text-gray-900 dark:text-white
                                              placeholder-gray-500 dark:placeholder-gray-400" />
                                <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"></i>
                            </div>
                            <div class="flex items-center gap-2">
                                <select id="sort-select" class="px-4 py-3 rounded-lg bg-white/50 dark:bg-gray-800/50
                                                 border border-gray-300 dark:border-gray-700
                                                 focus:outline-none focus:ring-2 focus:ring-purple-400
                                                 text-gray-900 dark:text-white appearance-none">
                                    <option value="date" ${state.filters.sortBy === 'date' ? 'selected' : ''}>Sort by Date</option>
                                    <option value="popularity" ${state.filters.sortBy === 'popularity' ? 'selected' : ''}>Sort by Popularity</option>
                                </select>
                                <div class="flex items-center p-1 rounded-lg bg-gray-200/50 dark:bg-gray-700/50">
                                    <button onclick="handleFilterChange('viewMode', 'grid')" class="view-toggle-btn relative p-2 rounded-md ${state.filters.viewMode === 'grid' ? 'text-purple-600' : 'text-gray-500'} transition-colors">
                                        <i data-lucide="layout-grid"></i>
                                        ${state.filters.viewMode === 'grid' ? '<div class="absolute inset-0 bg-white dark:bg-gray-800 rounded-md shadow-sm z-[-1]"></div>' : ''}
                                    </button>
                                    <button onclick="handleFilterChange('viewMode', 'list')" class="view-toggle-btn relative p-2 rounded-md ${state.filters.viewMode === 'list' ? 'text-purple-600' : 'text-gray-500'} transition-colors">
                                        <i data-lucide="list"></i>
                                        ${state.filters.viewMode === 'list' ? '<div class="absolute inset-0 bg-white dark:bg-gray-800 rounded-md shadow-sm z-[-1]"></div>' : ''}
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div id="category-filters" class="px-2 pt-2 pb-1 flex flex-wrap gap-2">
                            ${categories.map(category => `
                                <button onclick="handleFilterChange('selectedCategory', '${category}')" 
                                        class="category-btn relative px-4 py-1.5 rounded-full text-sm font-medium transition-all transform hover:scale-105
                                               ${state.filters.selectedCategory === category
                                                   ? 'text-white'
                                                   : 'text-gray-700 dark:text-gray-300 bg-white/50 dark:bg-gray-800/50 hover:bg-white/80 dark:hover:bg-gray-800/80'}">
                                    ${category}
                                    ${state.filters.selectedCategory === category ? '<div class="absolute inset-0 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full z-[-1]"></div>' : ''}
                                </button>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Event Grid -->
                    <div id="event-grid-container">
                        ${renderEventGrid()}
                    </div>
                </div>
            `;
            
            // Start hero animation
            startHeroAnimation();
        }

        /**
         * Renders the Event Grid based on current state
         */
        function renderEventGrid() {
            if (state.isLoading) {
                return `
                    <div class="${state.filters.viewMode === 'grid' ? 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6' : 'flex flex-col gap-6'}">
                        ${[...Array(6)].map(() => createSkeletonCardHTML(state.filters.viewMode)).join('')}
                    </div>
                `;
            }

            const filteredEvents = getFilteredAndSortedEvents();

            if (filteredEvents.length === 0) {
                return `
                    <div class="text-center py-16">
                        <i data-lucide="search-x" class="w-16 h-16 mx-auto text-gray-400"></i>
                        <h3 class="mt-4 text-xl font-bold text-gray-800 dark:text-white">No Events Found</h3>
                        <p class="mt-1 text-gray-600 dark:text-gray-400">Try adjusting your search or filters.</p>
                    </div>
                `;
            }

            return `
                <div class="${state.filters.viewMode === 'grid' ? 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6' : 'flex flex-col gap-6'}">
                    ${filteredEvents.map((event, index) => createEventCardHTML(event, state.filters.viewMode, index)).join('')}
                </div>
            `;
        }

        /**
         * Renders the My Calendar Page
         */
        function renderMyCalendarPage() {
            if (!state.user) {
                mainContent.innerHTML = `
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-12 pb-24 text-center">
                        <i data-lucide="calendar-off" class="w-20 h-20 mx-auto text-gray-400"></i>
                        <h1 class="text-4xl md:text-5xl font-bold text-gray-900 dark:text-white mt-4 mb-4">
                            My Calendar
                        </h1>
                        <p class="text-lg text-gray-600 dark:text-gray-300 mb-8 max-w-2xl mx-auto">
                            Please <a onclick="openAuthModal('signin')" class="text-purple-500 font-medium hover:underline cursor-pointer">sign in</a> to see your registered events.
                        </p>
                    </div>
                `;
                return;
            }
            
            const registeredEvents = state.events
                .filter(event => event.isRegistered)
                .sort((a, b) => new Date(a.date) - new Date(b.date));

            let content;
            if (state.isLoading) {
                content = `
                    <div class="flex flex-col gap-6">
                        ${[...Array(3)].map(() => createSkeletonCardHTML('list')).join('')}
                    </div>
                `;
            } else if (registeredEvents.length === 0) {
                content = `
                    <div class="text-center py-16">
                        <i data-lucide="calendar-off" class="w-20 h-20 mx-auto text-gray-400"></i>
                        <h3 class="mt-4 text-2xl font-bold text-gray-800 dark:text-white">Your calendar is empty</h3>
                        <p class="mt-2 text-lg text-gray-600 dark:text-gray-400">Register for events to see them here.</p>
                    </div>
                `;
            } else {
                content = `
                    <div class="flex flex-col gap-6">
                        ${registeredEvents.map((event, index) => createEventCardHTML(event, 'list', index)).join('')}
                    </div>
                `;
            }

            mainContent.innerHTML = `
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-12 pb-24">
                    <h1 class="text-4xl md:text-5xl font-bold text-gray-900 dark:text-white mb-8">
                        My Calendar
                    </h1>
                    ${content}
                </div>
            `;
        }
        
        /**
         * Renders the Topic Vote Page
         */
        function renderTopicVotePage() {
            if (state.isLoading) {
                mainContent.innerHTML = `
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-12 pb-24">
                        <div class="h-10 bg-gray-200 dark:bg-gray-700 rounded w-1/2 mb-4"></div>
                        <div class="h-6 bg-gray-200 dark:bg-gray-700 rounded w-3/4 mb-8"></div>
                        <div class="flex flex-col gap-6">
                            ${[...Array(4)].map(() => createSkeletonCardHTML('list')).join('')}
                        </div>
                    </div>
                `;
                return;
            }
            
            const sortedTopics = [...state.topics].sort((a, b) => b.votes - a.votes);

            mainContent.innerHTML = `
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-12 pb-24">
                    <h1 class="text-4xl md:text-5xl font-bold text-gray-900 dark:text-white mb-4">
                        Vote for Future Events
                    </h1>
                    <p class="text-lg text-gray-600 dark:text-gray-300 mb-8 max-w-2xl">
                        Help shape our campus! Vote for the event topics you'd love to see next semester.
                    </p>
                    
                    <div class="flex flex-col gap-6">
                        ${sortedTopics.map((topic, index) => createTopicCardHTML(topic, index)).join('')}
                    </div>
                </div>
            `;
        }

        /**
         * Renders the Event Detail Page
         */
        function renderEventDetailPage() {
            const event = state.events.find(e => e.id === state.selectedEventId);

            if (!event) {
                mainContent.innerHTML = `
                    <div class="h-screen flex flex-col items-center justify-center">
                        <i data-lucide="alert-triangle" class="w-16 h-16 text-red-500"></i>
                        <h2 class="mt-4 text-2xl font-bold">Event Not Found</h2>
                        <button onclick="handleSetPage('home')" class="mt-4 px-4 py-2 bg-purple-500 text-white rounded-lg">
                            Go Back
                        </button>
                    </div>
                `;
                return;
            }
            
            const eventDate = new Date(event.date);
            const formattedDate = eventDate.toLocaleDateString('en-US', { dateStyle: 'medium' });
            const formattedTime = eventDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

            mainContent.innerHTML = `
                <div id="event-detail-scroller" class="h-screen w-full overflow-y-auto">
                    <!-- Back Button -->
                    <button onclick="handleBack()" 
                            class="fixed top-6 left-4 sm:left-6 lg:left-10 z-50 p-2
                                   rounded-full glass-nav text-gray-800 dark:text-white
                                   hover:bg-white/80 dark:hover:bg-gray-800/80
                                   shadow-lg border border-white/20 dark:border-gray-700/50
                                   transition-all transform hover:scale-110">
                        <i data-lucide="chevron-left"></i>
                    </button>
                    
                    <!-- Share Button -->
                    <button onclick="handleCopyLink(this)"
                            class="fixed top-6 right-4 sm:right-6 lg:right-10 z-50 p-2
                                   rounded-full glass-nav text-gray-800 dark:text-white
                                   hover:bg-white/80 dark:hover:bg-gray-800/80
                                   shadow-lg border border-white/20 dark:border-gray-700/50
                                   transition-all transform hover:scale-110">
                        <i data-lucide="share-2" class="share-icon"></i>
                        <i data-lucide="check-circle" class="check-icon hidden text-green-500"></i>
                    </button>

                    <!-- Header Image -->
                    <div class="relative h-64 md:h-96 w-full overflow-hidden">
                        <img id="event-detail-image" src="${event.imageUrl}" alt="${event.title}"
                             class="w-full h-full object-cover transition-transform duration-100"
                             onerror="this.src='https://placehold.co/1200x600/CCCCCC/333333?text=Image+Error'" />
                        <div class="absolute inset-0 bg-gradient-to-t from-gray-100/50 dark:from-gray-900/80 via-transparent to-transparent"></div>
                    </div>

                    <!-- Content -->
                    <div class="relative -mt-16 p-6 md:p-8 max-w-4xl mx-auto">
                        <div class="p-6 md:p-8 rounded-3xl glass-modal
                                    border border-white/20 dark:border-gray-700/50 shadow-2xl">
                            
                            <span class="px-3 py-1 rounded-full text-sm font-semibold
                                         bg-purple-100 dark:bg-purple-900/50 text-purple-700 dark:text-purple-300">
                                ${event.category}
                            </span>

                            <h1 class="mt-4 text-4xl md:text-5xl font-bold text-gray-900 dark:text-white">
                                ${event.title}
                            </h1>
                            <p class="mt-2 text-lg text-gray-600 dark:text-gray-400">
                                Organized by: ${event.organizer}
                            </p>

                            <!-- Event Info Grid -->
                            <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-6 text-center md:text-left">
                                ${createInfoPillHTML('clock', 'Date & Time', `${formattedDate} at ${formattedTime}`)}
                                ${createInfoPillHTML('map-pin', 'Location', event.location)}
                                ${createInfoPillHTML('users', 'Attendees', `${event.attendeeCount} going`)}
                            </div>

                            <!-- Description -->
                            <div class="mt-8 prose dark:prose-invert max-w-none">
                                <h2>About this event</h2>
                                <p>${event.description}</p>
                            </div>
                            
                            <!-- Tags -->
                            <div class="mt-6 flex flex-wrap gap-2">
                                ${event.tags.map(tag => `
                                    <span class="px-3 py-1 rounded-full text-xs font-medium
                                               bg-gray-200/50 dark:bg-gray-700/50
                                               text-gray-700 dark:text-gray-300">
                                        #${tag}
                                    </span>
                                `).join('')}
                            </div>

                            <!-- Registration Button -->
                            <div class="mt-10 pt-6 border-t border-gray-200 dark:border-gray-700">
                                ${event.isRegistered ? `
                                    <div class="flex flex-col gap-4">
                                        <div class="flex items-center justify-center space-x-2 px-6 py-3 rounded-xl font-semibold
                                                    bg-green-100 dark:bg-green-900/50 text-green-700 dark:text-green-300">
                                            <i data-lucide="check-circle" class="w-5 h-5"></i>
                                            <span>You are registered!</span>
                                        </div>
                                        <button onclick="handleCancelRegistration('${event.id}', true)" 
                                                class="cancel-btn w-full flex justify-center items-center px-6 py-3 rounded-xl font-semibold text-red-600
                                                       bg-red-100/50 dark:bg-red-900/50
                                                       hover:bg-red-100/80 dark:hover:bg-red-900/80
                                                       focus:outline-none focus:ring-4 focus:ring-red-300 dark:focus:ring-red-800
                                                       transition-all duration-300 ease-in-out
                                                       disabled:opacity-50 disabled:cursor-wait">
                                            <span>Cancel Registration</span>
                                            <i data-lucide="loader-2" class="w-5 h-5 animate-spin hidden"></i>
                                        </button>
                                    </div>
                                ` : `
                                    <button onclick="openModal('${event.id}')"
                                            class="w-full flex justify-center items-center px-6 py-4 rounded-xl font-semibold text-white
                                                       bg-gradient-to-r from-purple-500 to-pink-500
                                                       hover:from-purple-600 hover:to-pink-600
                                                       focus:outline-none focus:ring-4 focus:ring-purple-300 dark:focus:ring-purple-800
                                                       transition-all duration-300 ease-in-out shadow-lg hover:shadow-xl
                                                       text-lg transform hover:scale-[1.02]">
                                        Register Now
                                    </button>
                                `}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Add parallax scroll listener
            document.getElementById('event-detail-scroller').addEventListener('scroll', handleParallaxScroll);
        }
        
        // --- 5. HTML Template Functions ---
        
        /**
         * Creates HTML for auth form inputs (No longer used by new login)
         */
        function createAuthInputHTML(id, type, label, icon) {
             // Use bg-transparent for inputs inside auth modal
            return `
                <div class="relative form-input-container">
                    <i data-lucide="${icon}" class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400 z-10"></i>
                    <input id="${id}" name="${id}" type="${type}" required 
                           class="form-input peer w-full pl-12 pr-4 py-4 bg-transparent 
                                  border border-gray-300 dark:border-gray-700 rounded-lg 
                                  text-gray-900 dark:text-white 
                                  focus:outline-none focus:ring-2 focus:ring-purple-400 placeholder-transparent" 
                           placeholder="${label}" />
                    <label for="${id}" class="form-label left-12">${label}</label>
                </div>
            `;
        }

        /**
         * Creates HTML string for an Event Card
         */
        function createEventCardHTML(event, viewMode, index = 0) {
            const eventDate = new Date(event.date);
            const formattedDate = eventDate.toLocaleDateString('en-US', {
                weekday: 'short', month: 'short', day: 'numeric',
            });
            const formattedTime = eventDate.toLocaleTimeString('en-US', {
                hour: '2-digit', minute: '2-digit',
            });

            return `
                <div onclick="handleSelectEvent('${event.id}')"
                     style="--delay: ${index * 50}ms"
                     class="w-full rounded-2xl overflow-hidden cursor-pointer
                            glass-card border border-white/20 dark:border-gray-700/50
                            shadow-lg hover:shadow-2xl transition-all duration-300
                            transform hover:scale-[1.03] event-card-animated
                            ${viewMode === 'list' ? 'flex' : ''}">
                    
                    <!-- Image -->
                    <div class="relative overflow-hidden ${viewMode === 'list' ? 'w-1/3 flex-shrink-0' : 'w-full h-48'}">
                        <img src="${event.imageUrl}" alt="${event.title}" 
                             class="w-full h-full object-cover transition-transform duration-300 transform group-hover:scale-110"
                             onerror="this.src='https://placehold.co/600x400/CCCCCC/333333?text=Image+Error'" />
                        <div class="absolute top-2 left-2 px-3 py-1 rounded-full
                                    backdrop-blur-sm bg-black/30 text-white text-xs font-semibold">
                            ${event.category}
                        </div>
                    </div>

                    <!-- Content -->
                    <div class="p-4 flex flex-col justify-between ${viewMode === 'list' ? 'w-2/auto' : 'w-full'}">
                        <div>
                            <p class="text-sm text-purple-600 dark:text-purple-400 font-medium">
                                ${formattedDate} at ${formattedTime}
                            </p>
                            <h3 class="text-lg font-bold text-gray-900 dark:text-white mt-1 mb-1 truncate">
                                ${event.title}
                            </h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400 flex items-center mb-3">
                                <i data-lucide="map-pin" class="w-4 h-4 mr-1.5 flex-shrink-0"></i>
                                <span class="truncate">${event.location}</span>
                            </p>
                        </div>

                        <!-- Footer Actions -->
                        <div class="flex justify-between items-center mt-2">
                            ${createVoteButtonHTML(event.id, event.votesCount, event.isVoted, 'event')}

                            ${event.isRegistered ? `
                                <div class="flex items-center space-x-1.5 px-3 py-1.5 rounded-full text-sm font-medium
                                            bg-green-100 dark:bg-green-900/50 text-green-700 dark:text-green-300">
                                    <i data-lucide="check-circle" class="w-4 h-4"></i>
                                    <span>Registered</span>
                                </div>
                            ` : `
                                <button onclick="openModal('${event.id}', event)"
                                        class="px-4 py-1.5 rounded-full text-sm font-semibold text-white
                                               bg-gradient-to-r from-purple-500 to-pink-500
                                               hover:from-purple-600 hover:to-pink-600
                                               transition-all shadow hover:shadow-md transform hover:scale-105">
                                    Register
                                </button>
                            `}
                        </div>
                    </div>
                </div>
            `;
        }

        /**
         * Creates HTML string for a Topic Vote Card
         */
        function createTopicCardHTML(topic, index) {
            return `
                <div style="--delay: ${index * 50}ms"
                     class="w-full rounded-2xl overflow-hidden
                            glass-card border border-white/20 dark:border-gray-700/50
                            shadow-lg transition-all duration-300 event-card-animated
                            flex items-center p-4 gap-4">
                    
                    <!-- Vote Button -->
                    ${createVoteButtonHTML(topic.id, topic.votes, topic.isVoted, 'topic')}
                    
                    <!-- Content -->
                    <div class="flex-1">
                        <span class="px-3 py-1 rounded-full text-xs font-semibold
                                     bg-purple-100 dark:bg-purple-900/50 text-purple-700 dark:text-purple-300">
                            ${topic.category}
                        </span>
                        <h3 class="text-lg font-bold text-gray-900 dark:text-white mt-2">
                            ${topic.title}
                        </h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                            ${topic.description}
                        </p>
                    </div>
                </div>
            `;
        }


        /**
         * Creates HTML string for a Vote Button
         */
        function createVoteButtonHTML(id, votes, isVoted, type) {
            const handler = type === 'event' ? 'handleEventVoteClick' : 'handleTopicVoteClick';
            return `
                <button onclick="${handler}(this, '${id}', event)"
                        data-voted="${isVoted}"
                        class="vote-btn flex items-center ${type === 'topic' ? 'flex-col h-20 w-20' : 'space-x-1.5 px-3 py-1.5'} justify-center rounded-2xl text-sm font-medium
                               transition-all duration-200 ease-in-out transform hover:scale-105
                               ${isVoted
                                   ? 'bg-purple-500 text-white shadow-lg'
                                   : 'bg-white/50 hover:bg-white/80 dark:bg-gray-700/50 dark:hover:bg-gray-700/80 text-gray-700 dark:text-gray-200'}">
                    <i data-lucide="arrow-up" class="w-5 h-5"></i>
                    <span class="font-bold ${type === 'topic' ? 'text-lg' : ''}">${votes}</span>
                </button>
            `;
        }

        /**
         * Creates HTML string for a Skeleton Card
         */
        function createSkeletonCardHTML(viewMode) {
            return `
                <div class="rounded-2xl overflow-hidden animate-pulse ${viewMode === 'list' ? 'flex w-full space-x-4 p-4 glass-card' : 'w-full glass-card'}">
                    <div class="bg-gray-200 dark:bg-gray-700 ${viewMode === 'list' ? 'w-1/3 h-32 rounded-lg' : 'w-full h-48'}"></div>
                    <div class="p-4 ${viewMode === 'list' ? 'w-2/3 space-y-3' : 'w-full space-y-2'}">
                        <div class="h-6 bg-gray-200 dark:bg-gray-700 rounded w-3/4"></div>
                        <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded w-1/2"></div>
                        <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded w-1/4"></div>
                        <div class="flex justify-between items-center pt-2">
                            <div class="h-8 bg-gray-200 dark:bg-gray-700 rounded w-20"></div>
                            <div class="h-8 bg-gray-200 dark:bg-gray-700 rounded-full w-8"></div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        /**
         * Creates HTML string for an Info Pill (Event Detail Page)
         */
        function createInfoPillHTML(icon, title, text) {
             return `
                <div class="flex flex-col md:flex-row items-center gap-3 p-4
                            rounded-2xl bg-white/50 dark:bg-gray-800/50
                            border border-white/20 dark:border-gray-700/50">
                    <div class="flex-shrink-0 p-2 rounded-full
                              bg-gradient-to-br from-purple-100 to-pink-100
                              dark:from-purple-900/50 dark:to-pink-900/50
                              text-purple-600 dark:text-purple-300">
                        <i data-lucide="${icon}" class="w-5 h-5"></i>
                    </div>
                    <div>
                        <h4 class="text-sm font-semibold text-gray-600 dark:text-gray-400">${title}</h4>
                        <p class="text-base font-medium text-gray-900 dark:text-white">${text}</p>
                    </div>
                </div>
             `;
        }


        // --- 6. Event Handlers & Logic ---
        
        /**
         * Toggles between Sign In and Sign Up forms
         */
        function toggleAuthForm(form) {
            const signinForm = document.getElementById('signin-form');
            const signupForm = document.getElementById('signup-form');
            const signinTab = document.getElementById('tab-signin');
            const signupTab = document.getElementById('tab-signup');

            if (form === 'signin') {
                signinForm.style.display = 'block';
                signupForm.style.display = 'none';
                signinTab.classList.add('active');
                signupTab.classList.remove('active');
            } else {
                signinForm.style.display = 'none';
                signupForm.style.display = 'block';
                signinTab.classList.remove('active');
                signupTab.classList.add('active');
            }
        }

        /**
         * Handles mock login
         */
        function handleLogin(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            startLoading(btn);

            // Mock user data
            const mockUser = {
                uid: 'user123',
                name: 'Alex Johnson',
                // Use the 'email' field from the form
                email: e.target.email.value, 
                studentId: 'A12345678',
                department: 'Computer Science',
                year: '3',
                registeredEvents: ['1', '4'],
                votedEvents: ['1', '3', '6'],
                votedTopics: ['t1', 't2'],
            };
            
            // Simulate network request
            setTimeout(() => {
                state.user = mockUser;
                loadUserData(); // Load user-specific data
                stopLoading(btn);
                closeAuthModal(); // Close the modal
                showToast(`Welcome back, ${state.user.name}!`, 'success');
                handleSetPage('home'); // This will trigger renderApp
            }, 1000);
        }

        /**
         * Handles mock sign up (No longer wired up, but kept for future use)
         */
        function handleSignUp(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            startLoading(btn);
            
            const newUser = {
                uid: `user-${Date.now()}`,
                name: e.target['signup-name'].value,
                email: e.target['signup-email'].value,
                studentId: e.target['signup-studentid'].value,
                department: e.target['signup-department'].value,
                year: e.target['signup-year'].value,
                registeredEvents: [],
                votedEvents: [],
                votedTopics: [],
            };
            
            // Simulate network request
            setTimeout(() => {
                state.user = newUser;
                loadUserData(); // Load user-specific data
                stopLoading(btn);
                closeAuthModal(); // Close the modal
                showToast('Account created successfully!', 'success');
                handleSetPage('home'); // This will trigger renderApp
            }, 1000);
        }
        
        /**
         * Handles mock logout
         */
        function handleLogout() {
            toggleProfileDropdown(false); // Close dropdown
            state.user = null;
            state.notifications = [];
            
            // Reset events and topics, but check against anonymous votes
            state.events = state.events.map(e => ({
                ...e, 
                isRegistered: false, 
                isVoted: state.anonymousVotedEvents.includes(e.id) // Check anonymous list
            }));
            state.topics = state.topics.map(t => ({
                ...t, 
                isVoted: state.anonymousVotedTopics.includes(t.id) // Check anonymous list
            }));
            
            showToast('You have been logged out.', 'info');
            handleSetPage('home'); // This will re-render everything correctly
        }

        /**
         * Sets the current page and re-renders
         */
        function handleSetPage(page) {
            // Prevent access to calendar if not logged in
            if (page === 'myCalendar' && !state.user) {
                renderApp(); // Just re-render the current page
                openAuthModal('signin');
                showToast('Please sign in to see your calendar', 'info');
                return;
            }
            state.page = page;
            state.selectedEventId = null; // Clear selected event on page change
            window.scrollTo(0, 0);
            renderApp();
        }

        /**
         * Sets the selected event and navigates to detail page
         */
        function handleSelectEvent(eventId) {
            state.page = 'eventDetail';
            state.selectedEventId = eventId;
            renderApp();
        }

        /**
         * Navigates back to home page
         */
        function handleBack() {
            state.page = 'home';
            state.selectedEventId = null;
            renderApp();
        }

        /**
         * Toggles dark mode
         */
        function toggleDarkMode() {
            state.darkMode = !state.darkMode;
            if (state.darkMode) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            // Update icons on toggle button
            const toggle = document.getElementById('dark-mode-toggle');
            if (toggle) {
                toggle.querySelector('[data-lucide="moon"]').classList.toggle('hidden');
                toggle.querySelector('[data-lucide="sun"]').classList.toggle('hidden');
            }
        }

        /**
         * Handles filter changes and re-renders home page
         */
        function handleFilterChange(key, value) {
            state.filters[key] = value;
            // No need to re-render for search term, it's handled by debounced listener
            if(key !== 'searchTerm') {
                renderHomePage();
                lucide.createIcons();
            }
        }
        
        /**
         * Debounce utility
         */
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }
        
        /**
         * Debounced search handler
         */
        const debouncedSearch = debounce((value) => {
            handleFilterChange('searchTerm', value);
            renderHomePage(); // Re-render after search term changes
            lucide.createIcons();
        }, 300);

        /**
         * Gets filtered and sorted events
         */
        function getFilteredAndSortedEvents() {
            const { searchTerm, selectedCategory, sortBy } = state.filters;
            
            return state.events
                .filter((event) => {
                    if (selectedCategory !== 'All' && event.category !== selectedCategory) {
                        return false;
                    }
                    const searchLower = searchTerm.toLowerCase();
                    if (searchLower === '') return true;
                    return (
                        event.title.toLowerCase().includes(searchLower) ||
                        event.description.toLowerCase().includes(searchLower) ||
                        event.category.toLowerCase().includes(searchLower) ||
                        event.tags.some(tag => tag.toLowerCase().includes(searchLower))
                    );
                })
                .sort((a, b) => {
                    if (sortBy === 'popularity') {
                        return (b.votesCount || b.votes) - (a.votesCount || a.votes);
                    }
                    return new Date(a.date) - new Date(b.date);
                });
        }
        
        /**
         * Handles voting logic for events
         */
        function handleEventVoteClick(button, eventId, e) {
            e.stopPropagation(); // Prevent card click
            const event = state.events.find(e => e.id === eventId);
            handleVoteClick(button, event, 'votedEvents', 'votesCount');
        }
        
        /**
         * Handles voting logic for topics
         */
        function handleTopicVoteClick(button, topicId, e) {
            e.stopPropagation();
            const topic = state.topics.find(t => t.id === topicId);
            handleVoteClick(button, topic, 'votedTopics', 'votes');
        }
        
        /**
         * Generic voting logic
         */
        function handleVoteClick(button, item, userVoteListKey, votesCountKey) {
            /* REMOVED SIGN-IN CHECK
            if (!state.user) {
                openAuthModal('signin');
                showToast('Please sign in to vote', 'info');
                return;
            }
            */
            if (button.disabled) return;
            button.disabled = true;

            const isVoted = button.dataset.voted === 'true';
            
            // Optimistic update
            const newVotedState = !isVoted;
            const newVotesCount = isVoted ? item[votesCountKey] - 1 : item[votesCountKey] + 1;
            
            // Update item state
            item[votesCountKey] = newVotesCount;
            item.isVoted = newVotedState;
            
            // Update user state OR anonymous state
            let voteList;
            if (state.user) {
                voteList = state.user[userVoteListKey];
            } else {
                // Use anonymous state
                const anonymousListKey = userVoteListKey === 'votedEvents' ? 'anonymousVotedEvents' : 'anonymousVotedTopics';
                voteList = state[anonymousListKey];
            }

            if (newVotedState) {
                if (!voteList.includes(item.id)) { // Avoid duplicates
                    voteList.push(item.id);
                }
            } else {
                const index = voteList.indexOf(item.id);
                if (index > -1) {
                    voteList.splice(index, 1);
                }
            }

            // Update button UI
            button.dataset.voted = newVotedState;
            button.querySelector('span').textContent = newVotesCount;
            button.classList.toggle('bg-purple-500', newVotedState);
            button.classList.toggle('text-white', newVotedState);
            button.classList.toggle('shadow-lg', newVotedState);
            button.classList.toggle('bg-white/50', !newVotedState);
            button.classList.toggle('dark:bg-gray-700/50', !newVotedState);
            button.classList.toggle('text-gray-700', !newVotedState);
            button.classList.toggle('dark:text-gray-200', !newVotedState);

            // Add pop animation
            if (newVotedState) {
                button.classList.add('vote-btn-voted-animation');
                button.addEventListener('animationend', () => {
                    button.classList.remove('vote-btn-voted-animation');
                }, { once: true });
            }

            // Simulate network delay
            setTimeout(() => {
                button.disabled = false;
            }, 500);
        }
        
        /**
         * Opens the registration modal
         */
        function openModal(eventId, e) {
            if (e) e.stopPropagation();
            
            if (!state.user) {
                openAuthModal('signin');
                showToast('Please sign in to register', 'info');
                return;
            }

            const event = state.events.find(e => e.id === eventId);
            document.getElementById('modal-event-title').textContent = `For "${event.title}"`;
            document.getElementById('modal-event-id').value = event.id;
            
            // Populate form with user data
            document.getElementById('name').value = state.user.name;
            document.getElementById('email').value = state.user.email;
            document.getElementById('studentId').value = state.user.studentId;
            document.getElementById('department').value = state.user.department;
            document.getElementById('year').value = state.user.year;
            
            // Reset views
            modalFormView.classList.remove('hidden');
            modalSuccessView.classList.add('hidden');
            stopLoading(document.getElementById('modal-submit-btn'));
            
            // Show modal
            modal.classList.remove('hidden');
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
            }, 10);
        }

        /**
         * Closes the registration modal
         */
        function closeModal() {
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        /**
         * Closes the auth modal
         */
        function closeAuthModal() {
            const authModal = document.getElementById('auth-modal');
            const authModalContent = document.getElementById('auth-modal-content');
            authModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                authModal.classList.add('hidden');
                authModalContent.innerHTML = ''; // Clear content and listeners
            }, 300);
        }

        /**
         * Opens the auth modal (Updated)
         */
        function openAuthModal(defaultView = 'signin') {
            const authModal = document.getElementById('auth-modal');
            const authModalContent = document.getElementById('auth-modal-content');

            // Inject new content
            authModalContent.innerHTML = createAuthModalHTML();
            
            // Add stop propagation listener to the injected content
            // Need to be careful here, the form is the root
            authModalContent.querySelector('.auth-glass-form').addEventListener('click', (e) => e.stopPropagation());
            // Also stop propagation on tabs
            authModalContent.querySelector('.auth-tabs').addEventListener('click', (e) => e.stopPropagation());
            
            // Set up form listeners
            document.getElementById('signin-form').addEventListener('submit', handleLogin);
            document.getElementById('signup-form')?.addEventListener('submit', handleSignUp);
            
            // Set default tab
            toggleAuthForm(defaultView);

            // Show modal
            authModal.classList.remove('hidden');
            setTimeout(() => {
                authModalContent.classList.remove('scale-95', 'opacity-0');
            }, 10);
            
            // Init icons
            lucide.createIcons();
        }
        
        /**
         * Handles registration form submission
         */
        function handleRegistration(e) {
            e.preventDefault();
            const submitBtn = document.getElementById('modal-submit-btn');
            startLoading(submitBtn);
            
            const eventId = document.getElementById('modal-event-id').value;
            const event = state.events.find(e => e.id === eventId);
            
            // Simulate network request
            setTimeout(() => {
                // Update state
                event.isRegistered = true;
                event.attendeeCount += 1;
                state.user.registeredEvents.push(eventId);
                
                // Add a notification
                const notif = {
                    id: `n-${Date.now()}`,
                    text: `Your registration for "${event.title}" is confirmed!`,
                    read: false,
                    eventId: event.id,
                    time: new Date().toISOString()
                };
                state.notifications.unshift(notif);
                renderHeaderActions(); // Update bell icon
                
                // Show success message
                document.getElementById('modal-success-message').textContent = `See you at ${event.title}.`;
                modalFormView.classList.add('hidden');
                modalSuccessView.classList.remove('hidden');
                
                // Animate success icon
                const icon = modalSuccessView.querySelector('div');
                setTimeout(() => {
                    icon.classList.remove('scale-0');
                    icon.classList.add('scale-100', 'rotate-[360deg]');
                    icon.style.transition = 'transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1)';
                }, 100);

                showToast('Registration successful!', 'success');
                
                // Simulate reminder
                setTimeout(() => {
                    const reminderNotif = {
                         id: `n-${Date.now()}-reminder`,
                         text: `Reminder: "${event.title}" is starting in 1 hour!`,
                         read: false,
                         eventId: event.id,
                         time: new Date().toISOString()
                    };
                    state.notifications.unshift(reminderNotif);
                    renderHeaderActions(); // Update bell icon
                    showToast(`Reminder: "${event.title}" is starting in 1 hour!`, 'info');
                }, 5000); // 5 seconds instead of 1 hour for demo

                // Close modal and re-render
                setTimeout(() => {
                    closeModal();
                    renderApp(); // Re-render to show "Registered" status
                }, 1500);

            }, 1000);
        }

        /**
         * Handles cancel registration
         */
        function handleCancelRegistration(eventId, fromDetails = false) {
            if (!state.user) { // Security check
                openAuthModal('signin');
                return;
            }

            const button = document.querySelector('.cancel-btn');
            
            // Use a custom modal for confirmation instead of alert/confirm
            // For this demo, we'll skip the confirm modal and proceed
            // if (!confirm("Are you sure you want to cancel your registration?")) {
            //     return;
            // }

            if (button) {
                startLoading(button);
            }
            
            // Simulate network delay
            setTimeout(() => {
                const event = state.events.find(e => e.id === eventId);
                event.isRegistered = false;
                event.attendeeCount -= 1;
                state.user.registeredEvents = state.user.registeredEvents.filter(id => id !== eventId);
                
                showToast('Registration cancelled', 'info');
                
                if (fromDetails) {
                    handleBack();
                } else {
                    renderApp();
                }
            }, 1000);
        }

        /**
         * Handles parallax scroll on event detail page
         */
        function handleParallaxScroll(e) {
            const scroller = e.target;
            const image = document.getElementById('event-detail-image');
            if (!image) return;
            
            const scrollTop = scroller.scrollTop;
            const scale = 1 + (scrollTop / 1000);
            const y = scrollTop / 2;
            
            image.style.transform = `scale(${Math.min(scale, 1.5)}) translateY(${Math.min(y, 100)}px)`;
        }

        /**
         * Copies link to clipboard
         */
        function handleCopyLink(button) {
            // Use document.execCommand as fallback for iframe environments
            const url = window.location.href;
            const fallback = (e) => {
                e.preventDefault();
                document.removeEventListener('copy', fallback);
                showToast('Link copied to clipboard!', 'success');
                button.querySelector('.share-icon').classList.add('hidden');
                const checkIcon = button.querySelector('.check-icon');
                checkIcon.classList.remove('hidden');
                setTimeout(() => {
                    checkIcon.classList.add('hidden');
                    button.querySelector('.share-icon').classList.remove('hidden');
                }, 2000);
            };
            document.addEventListener('copy', fallback);
            document.execCommand('copy');
        }

        /**
         * Toggles the notification panel
         */
        function toggleNotificationPanel(force) {
            state.isNotificationPanelOpen = force !== undefined ? force : !state.isNotificationPanelOpen;
            
            toggleProfileDropdown(false); // Close profile dropdown

            if (state.isNotificationPanelOpen) {
                renderNotificationPanel(); // Re-render content
                notificationPanel.classList.remove('hidden');
                setTimeout(() => {
                    notificationPanel.classList.remove('scale-95', 'opacity-0', '-translate-y-2');
                }, 10);
            } else {
                notificationPanel.classList.add('scale-95', 'opacity-0', '-translate-y-2');
                setTimeout(() => {
                    notificationPanel.classList.add('hidden');
                }, 300);
            }
        }
        
        /**
         * Toggles the profile dropdown
         */
        function toggleProfileDropdown(force) {
            state.isProfileDropdownOpen = force !== undefined ? force : !state.isProfileDropdownOpen;

            toggleNotificationPanel(false); // Close notification panel

            if (state.isProfileDropdownOpen) {
                profileDropdown.classList.remove('hidden');
                setTimeout(() => {
                    profileDropdown.classList.remove('scale-95', 'opacity-0', '-translate-y-2');
                }, 10);
            } else {
                profileDropdown.classList.add('scale-95', 'opacity-0', '-translate-y-2');
                setTimeout(() => {
                    profileDropdown.classList.add('hidden');
                }, 300);
            }
        }
        
        /**
         * Renders notification list
         */
        function renderNotificationPanel() {
            if (state.notifications.length === 0) {
                notificationList.innerHTML = `
                    <div class="p-8 text-center text-gray-500 dark:text-gray-400">
                        <i data-lucide="bell-off" class="w-12 h-12 mx-auto"></i>
                        <p class="mt-2 text-sm">You have no notifications.</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }
            
            notificationList.innerHTML = state.notifications.map(n => `
                <button onclick="handleNotificationClick('${n.id}')"
                        class="w-full flex items-start gap-3 p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
                    <div class="flex-shrink-0 mt-1">
                        ${!n.read ? `
                            <div class="w-2 h-2 rounded-full bg-purple-500"></div>
                        ` : `
                            <div class="w-2 h-2 rounded-full bg-transparent"></div>
                        `}
                    </div>
                    <div class="flex-1 text-left">
                        <p class="text-sm text-gray-800 dark:text-gray-100">${n.text}</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">${timeAgo(n.time)}</p>
                    </div>
                </button>
            `).join('');
            lucide.createIcons();
        }

        /**
         * Handles clicking a notification
         */
        function handleNotificationClick(id) {
            const notif = state.notifications.find(n => n.id === id);
            if (!notif) return;
            
            notif.read = true;
            toggleNotificationPanel(false); // Close panel
            renderHeaderActions(); // Update badge
            
            if (notif.eventId) {
                handleSelectEvent(notif.eventId);
            } else if (notif.page) {
                handleSetPage(notif.page);
            }
        }

        /**
         * Updates nav button active states
         */
        function updateNav() {
            // Desktop
            document.querySelectorAll('.nav-button').forEach(btn => {
                const isPage = btn.dataset.page === state.page;
                btn.classList.toggle('text-gray-900', isPage);
                btn.classList.toggle('dark:text-white', isPage);
                btn.classList.toggle('text-gray-500', !isPage);
                btn.querySelector('.nav-underline').classList.toggle('hidden', !isPage);
            });
            // Mobile
            document.querySelectorAll('.mobile-nav-button').forEach(btn => {
                const isPage = btn.dataset.page === state.page;
                btn.classList.toggle('text-purple-500', isPage);
                btn.classList.toggle('text-gray-500', !isPage);
                btn.querySelector('.mobile-nav-active').classList.toggle('hidden', !isPage);
            });
        }
        
        /**
         * Shows a toast notification
         */
        function showToast(message, type = 'info') {
            const id = `toast-${state.toastId++}`;
            const icons = {
                info: 'info',
                success: 'check-circle',
                error: 'alert-triangle',
            };
            const colors = {
                info: 'text-blue-500',
                success: 'text-green-500',
                error: 'text-red-500',
            };

            const toast = document.createElement('div');
            toast.id = id;
            toast.className = `relative w-full max-w-sm p-4 rounded-2xl shadow-lg
                               glass-modal border border-white/20 dark:border-gray-700/50
                               transform transition-all duration-300 opacity-0 translate-y-4`;
            toast.innerHTML = `
                <div class="flex items-start space-x-3">
                    <div class="flex-shrink-0">
                        <i data-lucide="${icons[type]}" class="${colors[type]}"></i>
                    </div>
                    <p class="flex-1 text-sm font-medium text-gray-800 dark:text-gray-100">
                        ${message}
                    </p>
                    <button onclick="document.getElementById('${id}').remove()"
                            class="p-1 -m-1 rounded-full text-gray-400 hover:text-gray-700 dark:hover:text-gray-200
                                   focus:outline-none focus:ring-2 focus:ring-purple-400">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
            `;
            
            toastContainer.appendChild(toast);
            lucide.createIcons();
            
            // Animate in
            setTimeout(() => {
                toast.classList.remove('opacity-0', 'translate-y-4');
            }, 10);

            // Auto-remove
            setTimeout(() => {
                toast.classList.add('opacity-0', 'scale-90');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        /**
         * Animates hero text
         */
        function startHeroAnimation() {
            const words = ['Discover.', 'Connect.', 'Experience.'];
            let index = 0;
            const el = document.getElementById('hero-word');
            if (!el) return;

            setInterval(() => {
                index = (index + 1) % words.length;
                el.classList.add('hero-word-exit');
                
                setTimeout(() => {
                    el.textContent = words[index];
                    el.classList.remove('hero-word-exit');
                    el.classList.add('hero-word-enter');
                }, 500);
                
                setTimeout(() => {
                     el.classList.remove('hero-word-enter');
                }, 510);
                
            }, 2500);
        }
        
        // --- 8. Utility Functions ---
        
        function getInitials(name) {
            if (!name) return '';
            const parts = name.split(' ');
            if (parts.length > 1) {
                return parts[0][0].toUpperCase() + parts[parts.length - 1][0].toUpperCase();
            }
            return name.substring(0, 2).toUpperCase();
        }
        
        function startLoading(button) {
            button.disabled = true;
            button.querySelector('span').classList.add('hidden');
            button.querySelector('i').classList.remove('hidden');
        }
        
        function stopLoading(button) {
             button.disabled = false;
            button.querySelector('span').classList.remove('hidden');
            button.querySelector('i').classList.add('hidden');
        }
        
        function timeAgo(dateString) {
            const now = new Date();
            const date = new Date(dateString);
            const seconds = Math.floor((now - date) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + "y ago";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + "mo ago";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + "d ago";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + "h ago";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + "m ago";
            return "Just now";
        }


        // --- 7. Initialization ---
        
        /**
         * Loads public data on init
         */
        function loadPublicData() {
            state.isLoading = true;
            // Simulate fetch
            setTimeout(() => {
                state.events = sampleEvents.map(event => ({
                    ...event,
                    isRegistered: false,
                    isVoted: false,
                }));
                state.topics = sampleTopics.map(topic => ({
                    ...topic,
                    isVoted: false,
                }));
                state.isLoading = false;
                renderApp(); // Initial render after data is loaded
            }, 500); // Simulate network delay
        }
        
        /**
         * Loads user-specific data after login
         */
        function loadUserData() {
            // state.user is already set
            
            // Merge anonymous votes into user's votes FIRST
            state.anonymousVotedEvents.forEach(eventId => {
                if (!state.user.votedEvents.includes(eventId)) {
                    state.user.votedEvents.push(eventId);
                }
            });
            state.anonymousVotedTopics.forEach(topicId => {
                if (!state.user.votedTopics.includes(topicId)) {
                    state.user.votedTopics.push(topicId);
                }
            });

            // Clear anonymous votes
            state.anonymousVotedEvents = [];
            state.anonymousVotedTopics = [];

            // NOW, update events based on the *merged* user data
            state.events = state.events.map(event => ({
                ...event,
                isRegistered: state.user.registeredEvents.includes(event.id),
                isVoted: state.user.votedEvents.includes(event.id),
            }));
            // Update topics
            state.topics = state.topics.map(topic => ({
                ...topic,
                isVoted: state.user.votedTopics.includes(topic.id),
            }));
            state.notifications = sampleNotifications; // Load user-specific notifications
        }
        
        /**
         * Loads initial data and sets up listeners
         */
        function initApp() {
            // Set up global event listeners
            document.getElementById('modal-close-btn').addEventListener('click', closeModal);
            modal.addEventListener('click', closeModal);
            modalContent.addEventListener('click', (e) => e.stopPropagation());

            // Add listeners for the new auth modal backdrop
            const authModal = document.getElementById('auth-modal');
            authModal.addEventListener('click', closeAuthModal);
            
            document.getElementById('registration-form').addEventListener('submit', handleRegistration);
            
            // Global click listener to close popovers
            document.addEventListener('click', (e) => {
                if (state.isNotificationPanelOpen && !notificationPanel.contains(e.target) && !document.getElementById('notification-toggle')?.contains(e.target)) {
                    toggleNotificationPanel(false);
                }
                if (state.isProfileDropdownOpen && !profileDropdown.contains(e.target) && !document.getElementById('profile-toggle')?.contains(e.target)) {
                    toggleProfileDropdown(false);
                }
            });
            
            // Use event delegation for dynamic content
            document.getElementById('main-content').addEventListener('input', (e) => {
                if (e.target.id === 'search-input') {
                    debouncedSearch(e.target.value);
                }
                if (e.target.id === 'sort-select') {
                    handleFilterChange('sortBy', e.target.value);
                }
            });

            // Load public data and do initial render
            loadPublicData();
        }

        // Run app on load
        window.onload = initApp;

    </script>
</body>
</html>

